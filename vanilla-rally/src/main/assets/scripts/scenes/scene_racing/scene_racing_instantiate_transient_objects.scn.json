{
  "declare_macro": "scene_racing_instantiate_transient_objects",
  "content": [
    {
      "comment": "Car instance"
    },
    {
      "required": ["%IF_CREATE_PC_CAR"],
      "playback":  "create_$$vehicles/$selected_vehicle_id/class",
      "let": {
        "human_name": "%%vehicles/$selected_vehicle_id/suffix",
        "SKATER_NAME": "%%vehicles/$selected_vehicle_id/suffix",
        "car_name": "%%vehicles/$selected_vehicle_id/suffix",
        "velocity": "%vehicle_velocity",
        "angular_velocity": "%vehicle_angular_velocity",
        "if_human_style": true,
        "IF_SKATER_STYLE": true,
        "if_car_body_renderable_style": true,
        "color": "%SELECTED_PLAYER_VEHICLE_COLOR",
        "suffix": "",
        "if_with_graphics": true,
        "if_with_physics": true,
        "IF_WITH_GUN": false,
        "hand_brake_pulled": false,
        "mute": false,
        "velocity_error_std": 0,
        "error_alpha": null,
        "yaw_error_std": 0,
        "pitch_error_std": 0,
        "respawn_cooldown_time": 0,
        "IF_SHADOW": true,
        "IF_PLAYBACK_TRACK": false,
        "IF_PLAYBACK_WINNER": false,
        "IF_SPAWNER": true,
        "IF_DAMAGEABLE": false,
        "spawner_name": "%vip_name"
      }
    },
    {
      "required": ["%IF_BURN_IN"],
      "call": "burn_in",
      "arguments": {
        "seconds": 20
      }
    },
    {
      "comment": "Recording"
    },
    {
      "required": ["%if_record_track"],
      "call": "record_track",
      "arguments": { "node": "car_node", "filename": "/tmp/track.m" }
    },
    {
      "required": ["%if_record_track"],
      "call": "record_track_gpx",
      "arguments": { "node": "car_node", "filename": "/tmp/track.gpx" }
    },
    {
      "required": ["%IF_PLAYBACK_CHECKPOINTS"],
      "playback": "create_playback",
      "arguments": {
        "PLAYBACK_FILENAME": "%CHECKPOINTS_FILE",
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR": "M3",
        "PSUFFIX": "checkpoints"
      }
    },
    {
      "required": ["%IF_PLAYBACK_TRACK_1"],
      "playback": "create_playback",
      "arguments": {
        "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track1.m",
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR": "M3",
        "PSUFFIX": "track1"
      }
    },
    {
      "required": ["%IF_PLAYBACK_TRACK_2"],
      "playback": "create_playback",
      "arguments": {
        "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track2.m",
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR": "XZ",
        "PSUFFIX": "track2"
      }
    },
    {
      "required": ["%IF_PLAYBACK_TRACK_3"],
      "playback": "create_playback",
      "arguments": {
        "PLAYBACK_FILENAME": "$RECORDINGS_DIR/track3.m",
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR": "FN",
        "PSUFFIX": "track3"
      }
    },
    {
      "call": "define_winner_conditionals",
      "arguments": {
        "begin_rank": 0,
        "end_rank": 3
      }
    },
    {
      "required": ["%IF_PLAYBACK_WINNER_0", "%IF_WINNER_RANK0_EXISTS"],
      "playback": "_create_winner_playback",
      "arguments": {
        "RANK": 0,
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR":"$WINNER0_VEHICLE",
        "color": "%WINNER0_COLOR",
        "PSUFFIX": "'1'"
      }
    },
    {
      "required": ["%IF_PLAYBACK_WINNER_1", "%IF_WINNER_RANK1_EXISTS"],
      "playback": "_create_winner_playback",
      "arguments": {
        "RANK": 1,
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR":"$WINNER1_VEHICLE",
        "color": "%WINNER1_COLOR",
        "PSUFFIX": "'2'"
      }
    },
    {
      "required": ["%IF_PLAYBACK_WINNER_2", "%IF_WINNER_RANK2_EXISTS"],
      "playback": "_create_winner_playback",
      "arguments": {
        "RANK": 2,
        "PLAYBACK_SPEED": "%PLAYBACK_SPEED",
        "PLAYBACK_CAR":"$WINNER2_VEHICLE",
        "color": "%WINNER2_COLOR",
        "PSUFFIX": "'3'"
      }
    },
    {
      "required": ["%IF_CHECKPOINTS"],
      "call": "check_points",
      "arguments": {
        "moving_asset_id": "%%vehicles/$selected_vehicle_id/suffix",
        "moving_suffix": "",
        "resource": "glow",
        "player": "%vip_name",
        "nbeacons": 40,
        "distance": 30,
        "nahead": 30,
        "radius": 30,
        "height_changed": false,
        "track_filename": "%CHECKPOINTS_FILE",
        "track": "%checkpoints",
        "circular": "%%levels/$loaded_level_id/if_raceway_circular",
        "laps": "%RACE_LAPS",
        "pacenotes_filename": "%PACENOTES_FILE",
        "pacenotes_meters_ahead": 50,
        "pacenotes_minimum_covered_meters": 200,
        "pacenotes_maximum_number": 3,
        "pacenotes_pictures_left": [
          "pacenote_l0",
          "pacenote_l1",
          "pacenote_l2",
          "pacenote_l3",
          "pacenote_l4",
          "pacenote_l5",
          "pacenote_l6",
          "pacenote_l7"],
        "pacenotes_pictures_right": [
          "pacenote_r0",
          "pacenote_r1",
          "pacenote_r2",
          "pacenote_r3",
          "pacenote_r4",
          "pacenote_r5",
          "pacenote_r6",
          "pacenote_r7"],
        "pacenotes_ttf": "fonts/RobotoMono-Bold.ttf",
        "pacenotes_font_color": "%SCENE_FONT_COLOR",
        "pacenotes_font_height": "huge",
        "pacenotes_widget_distance": "pacenotes_widget_distance",
        "pacenotes_text_left": "pacenotes_text_left",
        "pacenotes_text_right": "pacenotes_text_right",
        "pacenotes_text_bottom": "pacenotes_text_bottom",
        "pacenotes_text_top": "pacenotes_text_top",
        "pacenotes_picture_left": "pacenotes_picture_left",
        "pacenotes_picture_right": "pacenotes_picture_right",
        "pacenotes_picture_bottom": "pacenotes_picture_bottom",
        "pacenotes_picture_top": "pacenotes_picture_top",
        "selection_emissivity": "%CHECK_POINTS_ACTIVE_COLOR",
        "deselection_emissivity": "%CHECK_POINTS_INACTIVE_COLOR",
        "on_finish": {
          "call": "set_focuses",
          "arguments": {"focuses": ["menu", "game_over_countdown_pending"]}
        },
        "focus_mask": "scene|countdown_any|game_over_countdown_any"
      }
    },
    {
      "comment": "Cameras"
    },
    {
      "required": ["%IF_CREATE_PC_CAR"],
      "execute": [
        {
          "call": "create_externals",
          "arguments": {
            "player": "%vip_name",
            "mode": "pc"
          }
        },
        {
          "call": "create_internals",
          "arguments": {
            "player": "%vip_name",
            "role": "driver"
          }
        }
      ]
    }
  ]
}
